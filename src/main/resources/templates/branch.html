<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locations - E-Wallet Biz</title>
    <link rel="stylesheet" href="/css/modern-banking.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        .location-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .location-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
            z-index: 1;
        }

        .card-image-header {
            height: 150px;
            width: 100%;
            background: #f0fdf4;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-image-header img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .location-card:hover .card-image-header img {
            transform: scale(1.05);
            /* Subtle zoom effect */
        }

        .card-content {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex: 1;
            justify-content: space-between;
        }

        .location-type-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Map Styles */
        #map {
            height: 450px;
            width: 100%;
            border-radius: var(--radius);
            z-index: 1;
        }

        .map-container {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            position: relative;
        }

        .map-loading {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div class="dashboard-container" style="flex-direction: column; background: var(--bg-color);">

        <!-- Header Section -->
        <header class="page-header" style="margin: 0;">
            <div
                style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h2 style="margin: 0; font-size: 1.75rem;"><i class="fas fa-map-marked-alt"></i> Find Locations</h2>
                    <p style="margin: 5px 0 0; opacity: 0.9;">Locate the nearest Branch or ATM</p>
                </div>
                <a href="/first" class="btn"
                    style="background: rgba(255,255,255,0.25); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </header>

        <section class="page-content"
            style="max-width: 1200px; margin: 1rem auto 2rem; width: 100%; padding: 0 1.5rem; flex: 1; z-index: 10;">

            <!-- Search & Filter -->
            <div class="section-card"
                style="margin-bottom: 2rem; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                <form action="/branch/search" method="get"
                    style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <div class="input-group" style="flex: 1; margin: 0;">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" name="search" class="form-control"
                            placeholder="Search by city, area, or branch name..." th:value="${searchTerm}"
                            style="border: none; background: transparent; margin: 0;">
                    </div>
                    <button type="submit" class="btn btn-primary" style="padding: 0.8rem 1.5rem;">
                        <i class="fas fa-filter"></i> Find
                    </button>
                    <a href="/branch" class="btn btn-secondary" style="padding: 0.8rem 1.5rem;" th:if="${searchTerm}">
                        <i class="fas fa-undo"></i> Reset
                    </a>
                </form>
            </div>

            <!-- Map Section -->
            <div class="map-container" th:if="${not #lists.isEmpty(branches)}">
                <div id="map-loading" class="map-loading"><i class="fas fa-sync fa-spin"></i> Locating addresses...
                </div>
                <div id="map"></div>
            </div>

            <!-- Locations Grid -->
            <div class="card-grid" th:if="${not #lists.isEmpty(branches)}">
                <div class="location-card" th:each="branch : ${branches}" th:id="'card-' + ${branch.id}"
                    th:data-lat="${branch.latitude != null ? branch.latitude : 0}"
                    th:data-lng="${branch.longitude != null ? branch.longitude : 0}" th:data-name="${branch.name}"
                    th:data-type="${branch.type}" th:data-location="${branch.location}">

                    <div class="location-type-badge">
                        <span class="badge" th:classappend="${branch.type == 'ATM'} ? 'info' : 'success'">
                            <i class="fas"
                                th:classappend="${branch.type == 'ATM'} ? 'fa-money-bill-wave' : 'fa-building'"></i>
                            <span th:text="${branch.type}">Type</span>
                        </span>
                    </div>

                    <div class="card-image-header">
                        <img th:src="@{/images/atm.png}" th:if="${branch.type == 'ATM'}" alt="ATM Location">
                        <img th:src="@{/images/branch.png}" th:unless="${branch.type == 'ATM'}" alt="Branch Location">
                    </div>

                    <div class="card-content">
                        <div>
                            <h3 th:text="${branch.name}"
                                style="margin: 0 0 0.5rem; color: var(--primary-color); font-size: 1.25rem;">Branch Name
                            </h3>

                            <p class="muted-text" style="font-size: 0.95rem; line-height: 1.5; margin-bottom: 1.5rem;">
                                <i class="fas fa-location-arrow"
                                    style="color: var(--primary-light); margin-right: 8px;"></i>
                                <span th:text="${branch.location}">Address Details Here</span>
                            </p>
                        </div>

                        <button class="btn btn-primary"
                            style="width: 100%; background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); margin-top: auto;"
                            th:data-address="${branch.location}" onclick="openDirections(this.dataset.address)">
                            <i class="fas fa-directions"></i> Get Directions
                        </button>
                    </div>
                </div>
            </div>

            <!-- No Results State -->
            <div th:if="${#lists.isEmpty(branches)}"
                style="text-align: center; padding: 4rem 2rem; background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                <div
                    style="width: 80px; height: 80px; background: var(--muted-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: var(--muted-text);">
                    <i class="fas fa-search-location" style="font-size: 2.5rem;"></i>
                </div>
                <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">No locations found</h3>
                <p class="muted-text" style="max-width: 400px; margin: 0 auto 1.5rem;">We couldn't find any branches or
                    ATMs matching your search criteria. Try a different search term or view all locations.</p>
                <a href="/branch" class="btn btn-primary">View All Locations</a>
            </div>

        </section>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script th:inline="javascript">
        // Directions Helper
        function openDirections(address) {
            if (address) {
                window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(address), '_blank');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Focus search
            const input = document.querySelector('input[name="search"]');
            if (input && /*[[${searchTerm}]]*/ null) {
                const val = input.value; input.value = ''; input.value = val; input.focus();
            }

            // Init Map
            const mapContainer = document.getElementById('map');
            if (!mapContainer) return;

            // Custom Icons
            const branchIcon = L.icon({
                iconUrl: '/images/branch.png',
                iconSize: [40, 40],
                iconAnchor: [20, 40], // Point of the icon which will correspond to marker's location
                popupAnchor: [0, -40]  // Point from which the popup should open relative to the iconAnchor
            });

            const atmIcon = L.icon({
                iconUrl: '/images/atm.png',
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });

            // Default Map: Dhaka
            const defaultLat = 23.8103;
            const defaultLng = 90.4125;
            const map = L.map('map').setView([defaultLat, defaultLng], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);

            const cards = document.querySelectorAll('.location-card');
            const markersBuffer = [];
            const loader = document.getElementById('map-loading');

            // Geocoding Helper
            async function geocodeAddress(address) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`, {
                        headers: { 'User-Agent': 'EWalletBankingApp/1.0' }
                    });
                    const data = await response.json();
                    if (data && data.length > 0) {
                        return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                    }
                } catch (e) { console.error("Geocoding failed for:", address); }
                return null;
            }

            async function processLocations() {
                let hasGeocodes = false;

                for (const card of cards) {
                    let lat = parseFloat(card.dataset.lat);
                    let lng = parseFloat(card.dataset.lng);
                    const name = card.dataset.name;
                    const type = card.dataset.type;
                    const address = card.dataset.location;

                    // If lat/lng are 0 or missing, try geocoding
                    if ((!lat || !lng || (lat === 0 && lng === 0)) && address) {
                        if (!hasGeocodes) {
                            if (loader) loader.style.display = 'block';
                            hasGeocodes = true;
                        }

                        // Rate limit: wait 1s
                        await new Promise(r => setTimeout(r, 1100));
                        const coords = await geocodeAddress(address);

                        if (coords) {
                            lat = coords.lat;
                            lng = coords.lon;
                            // Update card data for future interaction
                            card.dataset.lat = lat;
                            card.dataset.lng = lng;
                        } else {
                            // Fallback randomization nearby default
                            lat = defaultLat + (Math.random() - 0.5) * 0.05;
                            lng = defaultLng + (Math.random() - 0.5) * 0.05;
                        }
                    }

                    // Use correct icon
                    const icon = (type === 'ATM') ? atmIcon : branchIcon;
                    const marker = L.marker([lat, lng], { icon: icon }).addTo(map);

                    const popupContent = `<div style="text-align:center"><b>${name}</b><br><span class="badge" style="font-size:0.8em; margin-top:5px;">${type}</span></div>`;
                    marker.bindPopup(popupContent);

                    markersBuffer.push([lat, lng]);

                    // Card Click Interaction
                    card.addEventListener('click', () => {
                        map.flyTo([lat, lng], 16, { animate: true, duration: 1.5 });
                        marker.openPopup();
                        document.querySelector('.map-container').scrollIntoView({ behavior: 'smooth' });
                    });
                }

                if (loader) loader.style.display = 'none';

                // Fit bounds
                if (markersBuffer.length > 0) {
                    const bounds = L.latLngBounds(markersBuffer);
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
                }
            }

            // Start processing
            processLocations();
        });
    </script>
</body>

</html>